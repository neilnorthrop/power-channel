<h1>Aetherium Ascent</h1>

<%= button_to "Sign Out", destroy_user_session_path, method: :delete %>

<div id="toast-container"></div>

<h2>Your Stats</h2>
<div id="stats">
  <p>Level: <span id="level"></span></p>
  <p>Experience: <span id="experience"></span></p>
  <p>Skill Points: <span id="skill-points"></span></p>
</div>

<h2>Your Resources</h2>
<div id="resources"></div>

<h2>Actions</h2>
<div id="actions"></div>

<h2>Skills</h2>
<div id="skills"></div>

<h2>Inventory</h2>
<div id="inventory"></div>

<h2>Active Effects</h2>
<div id="active-effects"></div>

<h2>Crafting</h2>
<div id="crafting"></div>

<h2>Buildings</h2>
<div id="buildings"></div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const levelSpan = document.getElementById('level');
    const experienceSpan = document.getElementById('experience');
    const skillPointsSpan = document.getElementById('skill-points');
    const resourcesDiv = document.getElementById('resources');
    const actionsDiv = document.getElementById('actions');
    const skillsDiv = document.getElementById('skills');
    const inventoryDiv = document.getElementById('inventory');
    const activeEffectsDiv = document.getElementById('active-effects');
    const craftingDiv = document.getElementById('crafting');
    const buildingsDiv = document.getElementById('buildings');
    const toastContainer = document.getElementById('toast-container');
    const resourceBase = {};

    const showToast = (message, type = 'success') => {
      console.log('Showing toast:', message, type);
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = message;
      console.log('Toast created:', toast);
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    };

    const fetchUser = () => {
      fetch('/api/v1/user', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        levelSpan.innerText = data.data.attributes.level;
        experienceSpan.innerText = data.data.attributes.experience;
        skillPointsSpan.innerText = data.data.attributes.skill_points;
      });
    };

    const fetchResources = () => {
      return fetch('/api/v1/user_resources', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        resourcesDiv.innerHTML = '';
        const included = data.included || [];
        data.data.forEach(resource => {
          const related = included.find(inc => inc.id === resource.relationships.resource.data.id);
          if (related) {
            resourceBase[resource.attributes.name] = related.attributes.base_amount;
          }
          const resourceDiv = document.createElement('div');
          resourceDiv.innerHTML = `<strong>${resource.attributes.name}:</strong> ${resource.attributes.amount}`;
          resourcesDiv.appendChild(resourceDiv);
        });
      });
    };

    const fetchActions = () => {
      fetch('/api/v1/actions', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        actionsDiv.innerHTML = '';
        const actions = data.included.filter(inc => inc.type === 'action');
        data.data.forEach(userAction => {
          const action = actions.find(a => a.id === userAction.relationships.action.data.id);
          const actionDiv = document.createElement('div');
          const actionButton = document.createElement('button');
          actionButton.innerText = action.attributes.name;
          actionButton.addEventListener('click', () => {
            performAction(action.id);
          });
          actionDiv.appendChild(actionButton);

          const upgradeButton = document.createElement('button');
          upgradeButton.innerText = 'Upgrade';
          upgradeButton.addEventListener('click', () => {
            upgradeAction(userAction.id);
          });
          actionDiv.appendChild(upgradeButton);

          const cooldownSpan = document.createElement('span');
          cooldownSpan.id = `cooldown-${userAction.id}`;
          cooldownSpan.className = 'cooldown-visual';
          actionDiv.appendChild(cooldownSpan);

          actionsDiv.appendChild(actionDiv);

          updateCooldown(userAction);
        });
      });
    };

    const updateCooldown = (userAction) => {
      const cooldownSpan = document.getElementById(`cooldown-${userAction.id}`);
      if (!cooldownSpan) return;

      let attributes = userAction.attributes;
      if (userAction.data && userAction.data.attributes) {
        attributes = userAction.data.attributes;
      }


      if (attributes.last_performed_at) {
        const lastPerformedAt = new Date(attributes.last_performed_at);
        const cooldown = attributes.cooldown;
        const now = new Date();
        const diff = (now - lastPerformedAt) / 1000;

        if (diff < cooldown) {
          const remaining = Math.ceil(cooldown - diff);
          cooldownSpan.innerText = ` (Cooldown: ${remaining}s)`;
          setTimeout(() => updateCooldown(userAction), 1000);
        } else {
          cooldownSpan.innerText = '';
        }
      } else {
        cooldownSpan.innerText = '';
      }
    };

    const fetchSkills = () => {
      fetch('/api/v1/skills', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        skillsDiv.innerHTML = '';
        data.data.forEach(skill => {
          const skillDiv = document.createElement('div');
          skillDiv.innerHTML = `<strong>${skill.attributes.name}</strong> (${skill.attributes.cost} SP): ${skill.attributes.description}`;
          const unlockButton = document.createElement('button');
          unlockButton.innerText = 'Unlock';
          unlockButton.addEventListener('click', () => {
            unlockSkill(skill.id);
          });
          skillDiv.appendChild(unlockButton);
          skillsDiv.appendChild(skillDiv);
        });
      });
    };

    const fetchInventory = () => {
      fetch('/api/v1/items', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        inventoryDiv.innerHTML = '';
        data.data.forEach(item => {
          const attrs = item.attributes;
          const itemDiv = document.createElement('div');
          itemDiv.innerHTML = `<strong>${attrs.name}</strong> x${attrs.quantity}: ${attrs.description}`;
          const useButton = document.createElement('button');
          useButton.innerText = 'Use';
          useButton.addEventListener('click', () => {
            useItem(attrs.item_id);
          });
          itemDiv.appendChild(useButton);
          inventoryDiv.appendChild(itemDiv);
        });
      });
    };

    const fetchCrafting = () => {
      fetch('/api/v1/crafting', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        craftingDiv.innerHTML = '';
        const items = data.included.filter(inc => inc.type === 'item');
        data.data.forEach(recipe => {
          const item = items.find(i => i.id === recipe.relationships.item.data.id);
          const recipeDiv = document.createElement('div');
          recipeDiv.innerHTML = `<strong>${item.attributes.name}</strong>: `;
          const craftButton = document.createElement('button');
          craftButton.innerText = 'Craft';
          craftButton.addEventListener('click', () => {
            craftItem(recipe.id);
          });
          recipeDiv.appendChild(craftButton);
          craftingDiv.appendChild(recipeDiv);
        });
      });
    };

    const fetchActiveEffects = () => {
      fetch('/api/v1/active_effects', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        activeEffectsDiv.innerHTML = '';
        data.data.forEach(effect => {
          const attrs = effect.attributes;
          const effectDiv = document.createElement('div');
          activeEffectsDiv.appendChild(effectDiv);
          const updateTimer = () => {
            const expires = new Date(attrs.expires_at);
            const remaining = Math.max(0, Math.ceil((expires - new Date()) / 1000));
            effectDiv.innerHTML = `<strong>${attrs.name}</strong>: ${remaining}s`;
            if (remaining > 0) {
              setTimeout(updateTimer, 1000);
            } else {
              fetchActiveEffects();
            }
          };
          updateTimer();
        });
      });
    };

    const fetchBuildings = () => {
      fetch('/api/v1/buildings', {
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        buildingsDiv.innerHTML = '';
        data.data.forEach(building => {
          const level = building.attributes.level;
          const nextLevel = level + 1;
          const cost = Object.entries(resourceBase).map(([name, base]) => `${name}: ${base * nextLevel}`).join(', ');
          const buildingDiv = document.createElement('div');
          buildingDiv.innerHTML = `<strong>${building.attributes.name}</strong> (Level ${level}): ${building.attributes.description} - Upgrade Cost: ${cost}`;
          const upgradeButton = document.createElement('button');
          upgradeButton.innerText = 'Upgrade';
          upgradeButton.addEventListener('click', () => {
            upgradeBuilding(building.id);
          });
          buildingDiv.appendChild(upgradeButton);
          buildingsDiv.appendChild(buildingDiv);
        });
      });
    };

    const performAction = (actionId) => {
      fetch('/api/v1/actions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        },
        body: JSON.stringify({ action_id: actionId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
          fetchResources();
          fetchUser();
          fetchActions();
        }
      });
    };

    const upgradeAction = (actionId) => {
      fetch(`/api/v1/actions/${actionId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
        }
      });
    };

    const unlockSkill = (skillId) => {
      fetch('/api/v1/skills', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        },
        body: JSON.stringify({ skill_id: skillId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
        }
      });
    };

    const useItem = (itemId) => {
      fetch(`/api/v1/items/${itemId}/use`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
          fetchInventory();
          fetchActiveEffects();
        }
      });
    };

    const craftItem = (recipeId) => {
      fetch('/api/v1/crafting', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        },
        body: JSON.stringify({ recipe_id: recipeId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
        }
      });
    };

    const upgradeBuilding = (buildingId) => {
      fetch(`/api/v1/buildings/${buildingId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer <%= JsonWebToken.encode(user_id: current_user.id) %>`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          showToast(data.error, 'error');
        } else {
          showToast(data.message);
          fetchResources().then(() => fetchBuildings());
        }
      });
    };

    fetchUser();
    fetchResources().then(() => fetchBuildings());
    fetchActions();
    fetchSkills();
    fetchInventory();
    fetchCrafting();
    fetchActiveEffects();

    const cable = ActionCable.createConsumer('/cable?token=<%= JsonWebToken.encode(user_id: current_user.id) %>');

    cable.subscriptions.create('UserUpdatesChannel', {
      connected() {
        console.log('Connected to UserUpdatesChannel');
      },
      disconnected() {
        console.log('Disconnected from UserUpdatesChannel');
      },
      received(data) {
        console.log('Received data:', data);
        if (data.type === 'user_action_update') {
          updateCooldown(data.data.data);
        } else if (data.type === 'user_resource_update') {
          fetchResources();
        } else if (data.type === 'user_item_update') {
          fetchInventory();
        } else if (data.type === 'user_effect_update') {
          fetchActiveEffects();
        } else if (data.type === 'user_building_update') {
          fetchBuildings();
        } else if (data.type === 'user_skill_update') {
          fetchSkills();
        } else if (data.type === 'user_update') {
          fetchUser();
        }
      }
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/@rails/actioncable@7.0.0/app/assets/javascripts/actioncable.js"></script>
