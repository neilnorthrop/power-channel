<%= main_frame do %>
  <div class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">Dismantle Rules</h2>
      <%= link_to "Back to Content", owner_content_index_path(resource: 'dismantle'), class: "text-sm text-blue-600 hover:underline" %>
    </div>
    <div class="rounded border p-3 bg-white mb-2">
      <%= form_with url: owner_dismantles_path, method: :get, local: true, class: "flex items-end gap-2" do %>
        <div>
          <label class="block text-xs text-gray-600">Search</label>
          <%= text_field_tag :q, @q, class: 'border rounded px-2 py-1 text-sm', placeholder: 'item name' %>
        </div>
        <div>
          <%= submit_tag 'Apply', class: 'px-2 py-1 rounded bg-gray-800 text-white text-sm' %>
        </div>
      <% end %>
      <% if @q.present? && @rules.blank? %>
        <div class="mt-2 text-xs text-gray-700">
          No rules found.
          <%= link_to 'Create Dismantle Rule', new_owner_dismantle_path(item: @q), class: 'underline' %>
          or <%= link_to 'Create Item', new_owner_content_path(resource: 'items'), class: 'underline' %> if it does not exist.
        </div>
      <% end %>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500">
            <th class="py-2 pr-4">Item</th>
            <th class="py-2 pr-4">Yields</th>
            <th class="py-2 pr-4">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @rules.each do |r| %>
            <tr class="border-t">
              <td class="py-2 pr-4">
                <% name = Item.find_by(id: r.subject_id)&.name %>
                <span><%= name %></span>
                <% if name.present? %>
                  <button class="ml-2 text-xs px-1 py-0.5 rounded border" data-controller="clipboard" data-clipboard-value-value="<%= name %>" data-action="click->clipboard#copy">Copy</button>
                <% end %>
              </td>
              <td class="py-2 pr-4 text-xs">
                <% r.dismantle_yields.each do |y| %>
                  <div>
                    <%= y.component_type %> - <%= y.component_type == 'Resource' ? Resource.find_by(id: y.component_id)&.name : Item.find_by(id: y.component_id)&.name %> x <%= y.quantity %> @ <%= y.salvage_rate %><%= y.quality.present? ? " (#{y.quality})" : '' %>
                  </div>
                <% end %>
              </td>
              <td class="py-2 pr-4">
                <%= link_to 'Edit', edit_owner_dismantle_path(r), class: 'text-blue-600 hover:underline' %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>
